<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>ğŸ’§ Infusionsrechner</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1976d2">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: auto;
        }

        label {
            display: block;
            margin-top: 10px;
        }

        input {
            width: 100%;
            padding: 5px;
            font-size: 1em;
        }

        .result {
            margin-top: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
        }

        .log-entry {
            margin: 5px 0;
        }

        button {
            margin-top: 10px;
            padding: 8px 12px;
            font-size: 1em;
        }
    </style>
</head>

<body>
    <h1>Infusionsgeschwindigkeit Rechner ğŸ’§ </h1>

    <div class="container">
        <p>Gib die Werte ein, um die Infusionsgeschwindigkeit zu berechnen.</p>
        <p>Die Werte werden automatisch gespeichert, wenn du auf "Speichern" klickst oder nach 10 Sekunden InaktivitÃ¤t.
        </p>
        <p>Die Logs sind 30 Tage lang verfÃ¼gbar.</p>

        <label>ğŸ“¦ Milliliter:
            <input type="number" id="ml" value="200">
        </label>

        <label>â±ï¸ Zeit (Minuten):
            <input type="number" id="zeit" value="30">
        </label>

        <label>ğŸ’§ Tropfen je ml:
            <input type="number" id="tropfenProMl" value="20">
        </label>

        <button id="toggleLock">ğŸ”’ Speichern</button>

        <div class="result">
            <p>ğŸ“Š Flussrate (ml/min): <span id="rate">-</span></p>
            <p>ğŸ’§ Gesamte Tropfen: <span id="gesamtTropfen">-</span></p>
            <p>â³ Tropfen/Minute: <span id="tropfenProMin">-</span></p>
            <p><strong>â±ï¸ Tropfen/Sekunde:</strong> <span id="tropfenProSek">-</span></p>
        </div>

        <button onclick="exportToExcel()">ğŸ“¤ Exportieren als Excel (.xlsx)</button>
        <button onclick="deleteAllLogs()">ğŸ—‘ï¸ Alle Logs lÃ¶schen</button>

        <h2>ğŸ“œ Log:</h2>
        <div id="logDisplay"></div>

    </div>

    <script>
        const inputs = document.querySelectorAll("input");
        const toggleButton = document.getElementById("toggleLock");
        let isLocked = false;
        let inactivityTimer;

        function berechne() {
            const ml = parseFloat(document.getElementById("ml").value);
            const zeit = parseFloat(document.getElementById("zeit").value);
            const tropfenProMl = parseFloat(document.getElementById("tropfenProMl").value);

            if (isNaN(ml) || isNaN(zeit) || isNaN(tropfenProMl) || zeit <= 0) {
                document.getElementById("rate").textContent = "-";
                document.getElementById("gesamtTropfen").textContent = "-";
                document.getElementById("tropfenProMin").textContent = "-";
                document.getElementById("tropfenProSek").textContent = "-";
                return;
            }

            const rate = ml / zeit;
            const gesamtTropfen = ml * tropfenProMl;
            const tropfenProMin = gesamtTropfen / zeit;
            const tropfenProSek = tropfenProMin / 60;

            document.getElementById("rate").textContent = rate.toFixed(2);
            document.getElementById("gesamtTropfen").textContent = gesamtTropfen.toFixed(0);
            document.getElementById("tropfenProMin").textContent = tropfenProMin.toFixed(2);
            document.getElementById("tropfenProSek").textContent = tropfenProSek.toFixed(2);

            resetInactivityTimer(tropfenProSek.toFixed(2));
        }

        function toggleInputsLock() {
            isLocked = !isLocked;
            inputs.forEach(input => input.disabled = isLocked);
            toggleButton.textContent = isLocked ? "ğŸ”“ Eingabe entsperren" : "ğŸ”’ Speichern";

            if (isLocked) {
                const currentValue = document.getElementById("tropfenProSek").textContent;
                if (currentValue && currentValue !== "-") {
                    saveLog(currentValue, "manuell");
                }
            }
        }

        toggleButton.addEventListener("click", toggleInputsLock);
        inputs.forEach(input => input.addEventListener("input", berechne));

        function resetInactivityTimer(tropfenWert) {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                saveLog(tropfenWert, "autosave");
            }, 10000);
        }

        function saveLog(tropfenProSek, typ = "autosave") {
            const ml = parseFloat(document.getElementById("ml").value);
            const zeit = parseFloat(document.getElementById("zeit").value);

            const logs = JSON.parse(localStorage.getItem("tropfenLogs") || "[]");

            // Avoid duplicate autosaves
            if (typ === "autosave" && logs.length > 0) {
                const last = logs[logs.length - 1];
                if (last.value === tropfenProSek && last.ml === ml && last.zeit === zeit && last.type === "autosave") {
                    return;
                }
            }

            const timestamp = new Date().toISOString();
            logs.push({ value: tropfenProSek, timestamp, type: typ, ml: ml, zeit: zeit });
            localStorage.setItem("tropfenLogs", JSON.stringify(logs));
            cleanupOldLogs();
            showLogs();
        }

        function cleanupOldLogs() {
            const logs = JSON.parse(localStorage.getItem("tropfenLogs") || "[]");
            const now = new Date();
            const filtered = logs.filter(entry => {
                const entryDate = new Date(entry.timestamp);
                const diffDays = (now - entryDate) / (1000 * 60 * 60 * 24);
                return diffDays <= 30;
            });
            localStorage.setItem("tropfenLogs", JSON.stringify(filtered));
        }

        function showLogs() {
            const logs = JSON.parse(localStorage.getItem("tropfenLogs") || "[]");
            const display = document.getElementById("logDisplay");
            display.innerHTML = "";
            if (logs.length === 0) {
                display.innerHTML = "<p>Keine EintrÃ¤ge vorhanden.</p>";
            } else {
                logs.forEach((entry) => {
                    const date = new Date(entry.timestamp);
                    const label = entry.type === "manuell" ? "gespeichert" : "autosave";
                    const div = document.createElement("div");
                    div.className = "log-entry";
                    div.textContent = `${entry.value} Tropfen/Sek â€“ ${label} am ${date.toLocaleString("de-DE")} (ML: ${entry.ml}, Zeit: ${entry.zeit} min)`;
                    display.appendChild(div);
                });
            }
        }


        function exportToExcel() {
            const logs = JSON.parse(localStorage.getItem("tropfenLogs") || "[]");
            if (logs.length === 0) {
                alert("Keine Logs zum Exportieren vorhanden.");
                return;
            }

            let csv = "Tropfen/Sek;Typ;ML;Zeit (Minuten);Gespeichert am\n";
            logs.forEach(log => {
                const date = new Date(log.timestamp).toLocaleString("de-DE");
                const typ = log.type === "manuell" ? "gespeichert" : "autosave";
                csv += `${log.value};${typ};${log.ml};${log.zeit};${date}\n`;
            });

            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "TropfenLogs.xlsx"; // CSV disguised as XLSX
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }


        function deleteAllLogs() {
            if (confirm("MÃ¶chtest du wirklich alle Logs lÃ¶schen?")) {
                localStorage.removeItem("tropfenLogs");
                showLogs();
            }
        }

        window.onload = () => {
            berechne();
            cleanupOldLogs();
            showLogs();
        };
    </script>
</body>

</html>