<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Infusionsrechner</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: auto;
        }

        label {
            display: block;
            margin-top: 10px;
        }

        input {
            width: 100%;
            padding: 5px;
            font-size: 1em;
        }

        .result {
            margin-top: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
        }

        .log-entry {
            margin: 5px 0;
        }

        button {
            margin-top: 10px;
            padding: 8px 12px;
            font-size: 1em;
        }
    </style>
</head>

<body>
    <h1>Infusionsgeschwindigkeit Rechner</h1>

    <label>Milliliter:
        <input type="number" id="ml" value="200">
    </label>

    <label>Zeit (Minuten):
        <input type="number" id="zeit" value="30">
    </label>

    <label>Tropfen je ml:
        <input type="number" id="tropfenProMl" value="20">
    </label>

    <button id="toggleLock">Eingabe sperren</button>

    <div class="result">
        <p><strong>Flussrate (ml/min):</strong> <span id="rate">-</span></p>
        <p><strong>Gesamte Tropfen:</strong> <span id="gesamtTropfen">-</span></p>
        <p><strong>Tropfen/Minute:</strong> <span id="tropfenProMin">-</span></p>
        <p><strong>Tropfen/Sekunde:</strong> <span id="tropfenProSek">-</span></p>
    </div>

    <button onclick="exportToExcel()">Exportieren als Excel (.xlsx)</button>
    <button onclick="deleteAllLogs()">Alle Logs löschen</button>

    <h2>Log:</h2>
    <div id="logDisplay"></div>

    <script>
        const inputs = document.querySelectorAll("input");
        const toggleButton = document.getElementById("toggleLock");
        let isLocked = false;
        let inactivityTimer;

        function berechne() {
            const ml = parseFloat(document.getElementById("ml").value);
            const zeit = parseFloat(document.getElementById("zeit").value);
            const tropfenProMl = parseFloat(document.getElementById("tropfenProMl").value);

            if (isNaN(ml) || isNaN(zeit) || isNaN(tropfenProMl) || zeit <= 0) {
                document.getElementById("rate").textContent = "-";
                document.getElementById("gesamtTropfen").textContent = "-";
                document.getElementById("tropfenProMin").textContent = "-";
                document.getElementById("tropfenProSek").textContent = "-";
                return;
            }

            const rate = ml / zeit;
            const gesamtTropfen = ml * tropfenProMl;
            const tropfenProMin = gesamtTropfen / zeit;
            const tropfenProSek = tropfenProMin / 60;

            document.getElementById("rate").textContent = rate.toFixed(2);
            document.getElementById("gesamtTropfen").textContent = gesamtTropfen.toFixed(0);
            document.getElementById("tropfenProMin").textContent = tropfenProMin.toFixed(2);
            document.getElementById("tropfenProSek").textContent = tropfenProSek.toFixed(2);

            resetInactivityTimer(tropfenProSek.toFixed(2));
        }

        function toggleInputsLock() {
            isLocked = !isLocked;
            inputs.forEach(input => input.disabled = isLocked);
            toggleButton.textContent = isLocked ? "Eingabe entsperren" : "Eingabe sperren";

            if (isLocked) {
                const currentValue = document.getElementById("tropfenProSek").textContent;
                if (currentValue && currentValue !== "-") {
                    saveLog(currentValue, "manuell");
                }
            }
        }

        toggleButton.addEventListener("click", toggleInputsLock);
        inputs.forEach(input => input.addEventListener("input", berechne));

        function resetInactivityTimer(tropfenWert) {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                saveLog(tropfenWert, "autosave");
            }, 10000);
        }

        function saveLog(tropfenProSek, typ = "autosave") {
            const logs = JSON.parse(localStorage.getItem("tropfenLogs") || "[]");
            const timestamp = new Date().toISOString();
            logs.push({ value: tropfenProSek, timestamp, type: typ });
            localStorage.setItem("tropfenLogs", JSON.stringify(logs));
            cleanupOldLogs();
            showLogs();
        }

        function cleanupOldLogs() {
            const logs = JSON.parse(localStorage.getItem("tropfenLogs") || "[]");
            const now = new Date();
            const filtered = logs.filter(entry => {
                const entryDate = new Date(entry.timestamp);
                const diffDays = (now - entryDate) / (1000 * 60 * 60 * 24);
                return diffDays <= 30;
            });
            localStorage.setItem("tropfenLogs", JSON.stringify(filtered));
        }

        function showLogs() {
            const logs = JSON.parse(localStorage.getItem("tropfenLogs") || "[]");
            const display = document.getElementById("logDisplay");
            display.innerHTML = "";
            if (logs.length === 0) {
                display.innerHTML = "<p>Keine Einträge vorhanden.</p>";
            } else {
                logs.forEach((entry) => {
                    const date = new Date(entry.timestamp);
                    const label = entry.type === "manuell" ? "gespeichert" : "autosave";
                    const div = document.createElement("div");
                    div.className = "log-entry";
                    div.textContent = `${entry.value} Tropfen/Sek – ${label} am ${date.toLocaleString("de-DE")}`;
                    display.appendChild(div);
                });
            }
        }

        function exportToExcel() {
            const logs = JSON.parse(localStorage.getItem("tropfenLogs") || "[]");
            if (logs.length === 0) {
                alert("Keine Logs zum Exportieren vorhanden.");
                return;
            }

            let csv = "Tropfen/Sek;Typ;Gespeichert am\n";
            logs.forEach(log => {
                const date = new Date(log.timestamp).toLocaleString("de-DE");
                const typ = log.type === "manuell" ? "gespeichert" : "autosave";
                csv += `${log.value};${typ};${date}\n`;
            });

            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "TropfenLogs.xlsx"; // Excel-kompatibel trotz CSV
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function deleteAllLogs() {
            if (confirm("Möchtest du wirklich alle Logs löschen?")) {
                localStorage.removeItem("tropfenLogs");
                showLogs();
            }
        }

        window.onload = () => {
            berechne();
            cleanupOldLogs();
            showLogs();
        };
    </script>
</body>

</html>