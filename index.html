<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>üíß Infusionsrechner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ein einfacher Rechner zur Berechnung der Infusionsgeschwindigkeit.">
    <meta name="author" content="Max Oppermann">
    <meta name="keywords" content="Infusionsrechner, Tropfenrechner, Medizin, Gesundheit">
    <meta name="theme-color" content="#1976d2">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="icon.png">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1976d2">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
    <style>
        :root {
            --background-color: #ffffff;
            --text-color: #000000;
            --container-background: #fff;
            --result-background: #e0f7fa91;
            --log-entry-background: #f1f8e9;
            --log-display-background: #f9fbe7;
            --log-entry-odd: #e3f2fd;
            --log-entry-even: #fce4ec;
        }

        [data-theme="dark"] {
            --background-color: #121212;
            --text-color: #ffffff;
            --container-background: #1e1e1e;
            --result-background: #37474f;
            --log-entry-background: #263238;
            --log-display-background: #212121;
            --log-entry-odd: #37474f;
            --log-entry-even: #455a64;
        }

        body {
            font-family: sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: auto;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        label {
            display: block;
            margin-top: 10px;
        }

        input {
            width: 100%;
            padding: 5px;
            font-size: 1em;
            border-radius: 5px;
            background-color: var(--result-background);
            border: 0px
        }

        .result {
            margin-top: 20px;
            padding: 10px;
            background: var(--result-background);
            border-radius: 5px;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            background: var(--log-entry-background);
            border-radius: 5px;
        }

        button {
            margin-top: 10px;
            padding: 8px 12px;
            font-size: 1em;
        }

        #container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            text-align: center;
            color: var(--text-color);
        }

        h2 {
            margin-top: 20px;
            color: var(--text-color);
        }

        .container {
            background: var(--container-background);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .container #logDisplay {
            max-height: 333px;
            overflow-y: auto;
            margin-top: 10px;
            background: var(--log-display-background);
            padding: 10px;
            border-radius: 5px;
        }

        .container #logDisplay div.log-entry:nth-child(odd) {
            background: var(--log-entry-odd);
        }

        .container #logDisplay div.log-entry:nth-child(even) {
            background: var(--log-entry-even);
        }
        #darkModeToggle {
            float: right;
        }
    </style>
</head>

<body>
    <h1>Infusionsgeschwindigkeits Rechner üíß</h1>

    

    <div class="container">
        <p>Gib die Werte ein, um die Infusionsgeschwindigkeit zu berechnen.</p>
        <p>Die Werte werden automatisch gespeichert, wenn du auf "Speichern" klickst oder nach 10 Sekunden Inaktivit√§t.</p>
        <p>Die Logs sind 30 Tage lang verf√ºgbar.</p>

        <br>

        <label>üì¶ Milliliter:
            <input type="number" id="ml" value="200">
        </label>

        <label>‚è±Ô∏è Zeit (Minuten):
            <input type="number" id="zeit" value="30">
        </label>

        <label>üíß Tropfen je ml:
            <input type="number" id="tropfenProMl" value="20">
        </label>

        <button id="toggleLock">üîí Speichern (Tastensperre)</button>

        <div class="result">
            <p>üìä Flussrate (ml/min): <span id="rate">-</span></p>
            <p>üíß Gesamte Tropfen: <span id="gesamtTropfen">-</span></p>
            <p>‚è≥ Tropfen/Minute: <span id="tropfenProMin">-</span></p>
            <p><strong>‚è±Ô∏è Tropfen/Sekunde:</strong> <span id="tropfenProSek">-</span></p>
        </div>

        <h2>üìú Log:</h2>
        <div id="logDisplay"></div>

        <button onclick="exportToExcel()">üì§ Exportieren als Excel (.xlsx)</button>
        <button onclick="deleteAllLogs()">üóëÔ∏è Alle Logs l√∂schen</button>
        <button id="darkModeToggle">üåô</button>
    </div>

    <script>
        const darkModeToggle = document.getElementById("darkModeToggle");

        darkModeToggle.addEventListener("click", () => {
            const currentTheme = document.body.getAttribute("data-theme");
            const newTheme = currentTheme === "dark" ? "light" : "dark";
            document.body.setAttribute("data-theme", newTheme);
            darkModeToggle.textContent = newTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
        });

        const inputs = document.querySelectorAll("input");
        const toggleButton = document.getElementById("toggleLock");
        let isLocked = false;
        let inactivityTimer;

        function berechne() {
            const ml = parseFloat(document.getElementById("ml").value);
            const zeit = parseFloat(document.getElementById("zeit").value);
            const tropfenProMl = parseFloat(document.getElementById("tropfenProMl").value);

            if (isNaN(ml) || isNaN(zeit) || isNaN(tropfenProMl) || zeit <= 0) {
                document.getElementById("rate").textContent = "-";
                document.getElementById("gesamtTropfen").textContent = "-";
                document.getElementById("tropfenProMin").textContent = "-";
                document.getElementById("tropfenProSek").textContent = "-";
                return;
            }

            const rate = ml / zeit;
            const gesamtTropfen = ml * tropfenProMl;
            const tropfenProMin = gesamtTropfen / zeit;
            const tropfenProSek = tropfenProMin / 60;

            document.getElementById("rate").textContent = rate.toFixed(2);
            document.getElementById("gesamtTropfen").textContent = gesamtTropfen.toFixed(0);
            document.getElementById("tropfenProMin").textContent = tropfenProMin.toFixed(2);
            document.getElementById("tropfenProSek").textContent = tropfenProSek.toFixed(2);

            resetInactivityTimer(tropfenProSek.toFixed(2));
        }

        function toggleInputsLock() {
            isLocked = !isLocked;
            inputs.forEach(input => input.disabled = isLocked);
            toggleButton.textContent = isLocked ? "üîì Eingabe entsperren" : "üîí Speichern";

            if (isLocked) {
                const currentValue = document.getElementById("tropfenProSek").textContent;
                if (currentValue && currentValue !== "-") {
                    saveLog(currentValue, "manuell");
                }
            }
        }

        toggleButton.addEventListener("click", toggleInputsLock);
        inputs.forEach(input => input.addEventListener("input", berechne));

        function resetInactivityTimer(tropfenWert) {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                saveLog(tropfenWert, "autosave");
            }, 10000);
        }

        function saveLog(tropfenProSek, typ = "autosave") {
            const ml = parseFloat(document.getElementById("ml").value);
            const zeit = parseFloat(document.getElementById("zeit").value);

            const logs = JSON.parse(localStorage.getItem("tropfenLogs") || "[]");

            // Avoid duplicate autosaves
            if (typ === "autosave" && logs.length > 0) {
                const last = logs[logs.length - 1];
                if (last.value === tropfenProSek && last.ml === ml && last.zeit === zeit && last.type === "autosave") {
                    return;
                }
            }

            const timestamp = new Date().toISOString();
            logs.push({ value: tropfenProSek, timestamp, type: typ, ml: ml, zeit: zeit });
            localStorage.setItem("tropfenLogs", JSON.stringify(logs));
            cleanupOldLogs();
            showLogs();
        }

        function cleanupOldLogs() {
            const logs = JSON.parse(localStorage.getItem("tropfenLogs") || "[]");
            const now = new Date();
            const filtered = logs.filter(entry => {
                const entryDate = new Date(entry.timestamp);
                const diffDays = (now - entryDate) / (1000 * 60 * 60 * 24);
                return diffDays <= 30;
            });
            localStorage.setItem("tropfenLogs", JSON.stringify(filtered));
        }

        function showLogs() {
            const logs = JSON.parse(localStorage.getItem("tropfenLogs") || "[]");
            const display = document.getElementById("logDisplay");
            display.innerHTML = "";
            if (logs.length === 0) {
            display.innerHTML = "<p>Keine Eintr√§ge vorhanden.</p>";
            } else {
            logs.forEach((entry, index) => {
                const date = new Date(entry.timestamp);
                const label = entry.type === "manuell" ? "gespeichert" : "autosave";
                const div = document.createElement("div");
                div.className = "log-entry";
                div.textContent = `${entry.value} Tropfen/Sek ‚Äì ${label} am ${date.toLocaleString("de-DE")} (ML: ${entry.ml}, Zeit: ${entry.zeit} min)`;
                
                // Highlight the newest entry
                if (index === logs.length - 1) {
                div.style.fontWeight = "bold";
                }

                display.appendChild(div);
            });
            }
        }


        function exportToExcel() {
            const logs = JSON.parse(localStorage.getItem("tropfenLogs") || "[]");
            if (logs.length === 0) {
                alert("Keine Logs zum Exportieren vorhanden.");
                return;
            }

            let csv = "Tropfen/Sek;Typ;ML;Zeit (Minuten);Gespeichert am\n";
            logs.forEach(log => {
                const date = new Date(log.timestamp).toLocaleString("de-DE");
                const typ = log.type === "manuell" ? "gespeichert" : "autosave";
                csv += `${log.value};${typ};${log.ml};${log.zeit};${date}\n`;
            });

            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "TropfenLogs.xlsx"; // CSV disguised as XLSX
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }


        function deleteAllLogs() {
            if (confirm("M√∂chtest du wirklich alle Logs l√∂schen?")) {
                localStorage.removeItem("tropfenLogs");
                showLogs();
            }
        }


        window.onload = () => {
            berechne();
            cleanupOldLogs();
            showLogs();
        };
    </script>
</body>

</html>
